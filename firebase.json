rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper Functions
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    // User Profile
    match /user_profiles/{userId} {
      allow get: if true;
      allow list: if true; // Allow querying the collection for search
      allow write: if isOwner(userId);
    }

    // Public Pages & Links
    match /pages/{pageId} {
      allow get: if true; // Allow public access to any page that exists
      allow list: if true;
      allow create: if isOwner(request.resource.data.ownerId);
      allow update, delete: if isOwner(get(/databases/$(database)/documents/pages/$(pageId)).data.ownerId);

      match /links/{linkId} {
        allow get, list: if true;
        allow write: if isOwner(get(/databases/$(database)/documents/pages/$(pageId)).data.ownerId);
      }

      // Analytics Data
      match /page_views/{viewId} {
        allow get, list: if isSignedIn() && exists(/databases/$(database)/documents/pages/$(pageId)) && get(/databases/$(database)/documents/pages/$(pageId)).data.ownerId == request.auth.uid;
        allow write: if true;
      }

      match /link_clicks/{clickId} {
        allow get, list: if isSignedIn() && exists(/databases/$(database)/documents/pages/$(pageId)) && get(/databases/$(database)/documents/pages/$(pageId)).data.ownerId == request.auth.uid;
        allow write: if true;
      }
    }

    // Blog Posts
    match /posts/{postId} {
        allow read: if ('status' in resource.data && resource.data.status == 'published') || ('ownerId' in resource.data && isOwner(resource.data.ownerId));
        allow create: if isOwner(request.resource.data.ownerId);
        allow update, delete: if isOwner(get(/databases/$(database)/documents/posts/$(postId)).data.ownerId);
    }

    // Page Slug Lookups
    match /slug_lookups/{slug} {
      allow get: if true;
      allow create: if !exists(/databases/$(database)/documents/slug_lookups/$(slug)) && isOwner(get(/databases/$(database)/documents/pages/$(request.resource.data.pageId)).data.ownerId);
      allow update: if isOwner(get(/databases/$(database)/documents/pages/$(resource.data.pageId)).data.ownerId);
      allow delete: if isOwner(get(/databases/$(database)/documents/pages/$(resource.data.pageId)).data.ownerId);
    }

    // Username Lookups
    match /username_lookups/{username} {
      allow get: if true;
      allow create: if !exists(/databases/$(database)/documents/username_lookups/$(username)) && isOwner(request.resource.data.userId);
      allow delete: if isOwner(resource.data.userId);
      allow update: if false; // Deleting and creating a new one is safer
    }

    // Short Links (Private management data) - FINAL FIX
    match /short_links/{code} {
      // GET: Allow reading if the user is the owner. This is defensive.
      allow get: if 'ownerId' in resource.data && isOwner(resource.data.ownerId);

      // LIST: Allow a signed-in user to query the collection.
      // Firestore will then ensure the query itself (e.g., where("ownerId", "==", uid))
      // is secure by checking it against the `get` rule above.
      allow list: if isSignedIn();

      // CREATE: A new document must have the correct ownerId and the code must not already exist.
      allow create: if isOwner(request.resource.data.ownerId) 
                   && !exists(/databases/$(database)/documents/short_links/$(code));
                   
      // UPDATE/DELETE: The existing document's ownerId must match the user.
      allow update, delete: if isOwner(get(/databases/$(database)/documents/short_links/$(code)).data.ownerId);
    }

    // Short Links (Public data for redirection)
    match /short_link_public/{code} {
      // Anyone can get a link to be redirected.
      allow get: if true;
      
      // Anyone can update the clickCount, but not the originalUrl or add other fields.
      allow update: if request.resource.data.keys().hasOnly(['originalUrl', 'clickCount']) 
                   && request.resource.data.originalUrl == resource.data.originalUrl;

      // Creation/deletion only by signed-in users.
      // Creation is restricted to the minimal public fields to prevent abuse.
      allow create: if isSignedIn()
           && request.resource.data.keys().hasOnly(['originalUrl', 'clickCount'])
           && request.resource.data.originalUrl is string
           && request.resource.data.clickCount is int;
      allow delete: if isSignedIn() && get(/databases/$(database)/documents/short_links/$(code)).data.ownerId == request.auth.uid;
    }
  }
}
