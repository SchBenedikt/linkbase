rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper Functions
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    // User Profile
    match /user_profiles/{userId} {
      allow get: if true;
      allow list: if true; // Allow querying the collection for search
      allow write: if isOwner(userId);
    }

    // Public Pages & Links
    match /pages/{pageId} {
      allow get: if resource.data.status == 'published' || isOwner(resource.data.ownerId);
      allow list: if true;
      allow create: if isOwner(request.resource.data.ownerId);
      allow update, delete: if isOwner(get(/databases/$(database)/documents/pages/$(pageId)).data.ownerId);

      match /links/{linkId} {
        allow get, list: if true;
        allow write: if isOwner(get(/databases/$(database)/documents/pages/$(pageId)).data.ownerId);
      }

      // Analytics Data
      match /page_views/{viewId} {
        // Owner can read their own analytics
        allow get, list: if isOwner(get(/databases/$(database)/documents/pages/$(pageId)).data.ownerId);
        // Anyone can write (increment a counter)
        allow write: if true;
      }

      match /link_clicks/{clickId} {
        // Owner can read their own analytics
        allow get, list: if isOwner(get(/databases/$(database)/documents/pages/$(pageId)).data.ownerId);
        // Anyone can write (increment a counter)
        allow write: if true;
      }
    }

    // Blog Posts - DEFINITIVE FIX
    match /posts/{postId} {
        // GET Rule: A single post can be read if it's published OR if the user is the owner.
        // This is secure because it checks the document's actual data.
        allow get: if resource.data.status == 'published' || isOwner(resource.data.ownerId);

        // LIST Rule: A query on the collection is allowed.
        // For public queries (unauthenticated), Firestore will verify that the query's constraints 
        // (e.g., `where('status', '==', 'published')`) ensure that only documents permitted 
        // by the `get` rule are returned.
        // For private queries (e.g., by owner), Firestore verifies those constraints too.
        allow list: if true;

        // WRITE Rules:
        // On create, the new document's ownerId must match the user.
        allow create: if isOwner(request.resource.data.ownerId);
        // On update/delete, the existing document's ownerId must match the user.
        allow update, delete: if isOwner(get(/databases/$(database)/documents/posts/$(postId)).data.ownerId);
    }

    // Page Slug Lookups
    match /slug_lookups/{slug} {
      allow get: if true;
      allow create: if !exists(/databases/$(database)/documents/slug_lookups/$(slug)) && isOwner(get(/databases/$(database)/documents/pages/$(request.resource.data.pageId)).data.ownerId);
      allow update: if isOwner(get(/databases/$(database)/documents/pages/$(resource.data.pageId)).data.ownerId);
      allow delete: if isOwner(get(/databases/$(database)/documents/pages/$(resource.data.pageId)).data.ownerId);
    }

    // Username Lookups
    match /username_lookups/{username} {
      allow get: if true;
      allow create: if !exists(/databases/$(database)/documents/username_lookups/$(username)) && isOwner(request.resource.data.userId);
      allow delete: if isOwner(resource.data.userId);
      allow update: if false; // Deleting and creating a new one is safer
    }
  }
}
