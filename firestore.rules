rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper Functions
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    // User Profile
    match /user_profiles/{userId} {
      allow get: if true;
      allow list: if true; // Allow querying the collection for search
      allow write: if isOwner(userId);
    }

    // Public Pages & Links
    match /pages/{pageId} {
      allow get: if resource.data.status == 'published' || isOwner(resource.data.ownerId);
      allow list: if true;
      allow create: if isOwner(request.resource.data.ownerId);
      allow update, delete: if isOwner(get(/databases/$(database)/documents/pages/$(pageId)).data.ownerId);

      match /links/{linkId} {
        allow get, list: if true;
        allow write: if isOwner(get(/databases/$(database)/documents/pages/$(pageId)).data.ownerId);
      }

      // Analytics Data
      match /page_views/{viewId} {
        // Owner can read their own analytics
        allow get, list: if isSignedIn() && exists(/databases/$(database)/documents/pages/$(pageId)) && get(/databases/$(database)/documents/pages/$(pageId)).data.ownerId == request.auth.uid;
        // Anyone can write (increment a counter)
        allow write: if true;
      }

      match /link_clicks/{clickId} {
        // Owner can read their own analytics
        allow get, list: if isSignedIn() && exists(/databases/$(database)/documents/pages/$(pageId)) && get(/databases/$(database)/documents/pages/$(pageId)).data.ownerId == request.auth.uid;
        // Anyone can write (increment a counter)
        allow write: if true;
      }
    }

    // Blog Posts - DEFINITIVE FIX
    match /posts/{postId} {
        // GET Rule: A single post can be read if it's published OR if the user is the owner.
        // This is secure because it checks the document's actual data.
        allow get: if resource.data.status == 'published' || isOwner(resource.data.ownerId);

        // LIST Rule: A query on the collection is allowed.
        // For public queries (unauthenticated), Firestore will verify that the query's constraints 
        // (e.g., `where('status', '==', 'published')`) ensure that only documents permitted 
        // by the `get` rule are returned.
        // For private queries (e.g., by owner), Firestore verifies those constraints too.
        allow list: if true;

        // WRITE Rules:
        // On create, the new document's ownerId must match the user.
        allow create: if isOwner(request.resource.data.ownerId);
        // On update/delete, the existing document's ownerId must match the user.
        allow update, delete: if isOwner(get(/databases/$(database)/documents/posts/$(postId)).data.ownerId);
    }

    // Page Slug Lookups
    match /slug_lookups/{slug} {
      allow get: if true;
      allow create: if !exists(/databases/$(database)/documents/slug_lookups/$(slug)) && isOwner(get(/databases/$(database)/documents/pages/$(request.resource.data.pageId)).data.ownerId);
      allow update: if isOwner(get(/databases/$(database)/documents/pages/$(resource.data.pageId)).data.ownerId);
      allow delete: if isOwner(get(/databases/$(database)/documents/pages/$(resource.data.pageId)).data.ownerId);
    }

    // Username Lookups
    match /username_lookups/{username} {
      allow get: if true;
      allow create: if !exists(/databases/$(database)/documents/username_lookups/$(username)) && isOwner(request.resource.data.userId);
      allow delete: if isOwner(resource.data.userId);
      allow update: if false; // Deleting and creating a new one is safer
    }

    // Short Links (Private management data)
    match /short_links/{code} {
      // Owner can get, update, or delete their own specific link.
      allow get, update, delete: if isOwner(resource.data.ownerId);
      
      // A signed-in user can query the collection. Firestore will then apply the 'get' rule
      // to the results, ensuring only documents matching the query are returned.
      allow list: if isSignedIn();

      // Owner can create new links. Rule prevents overwriting.
      allow create: if isOwner(request.resource.data.ownerId) && !exists(/databases/$(database)/documents/short_links/$(code));
    }

    // Short Links (Public data for redirection)
    match /short_link_public/{code} {
      // Anyone can get a link to be redirected.
      allow get: if true;
      
      // Anyone can update the clickCount, but not the originalUrl or add other fields.
      allow update: if request.resource.data.keys().hasOnly(['originalUrl', 'clickCount']) 
                   && request.resource.data.originalUrl == resource.data.originalUrl;

      // Creation/deletion only by owner of the corresponding private link.
      // This requires the user to be signed in.
      allow create, delete: if isSignedIn() && get(/databases/$(database)/documents/short_links/$(code)).data.ownerId == request.auth.uid;
    }
  }
}
