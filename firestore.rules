rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper Functions
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    // User Profile
    match /user_profiles/{userId} {
      allow get: if true;
      allow list: if true; // Allow querying the collection for search
      allow write: if isOwner(userId);
    }

    // Public Pages & Links
    match /pages/{pageId} {
      allow get: if resource.data.status == 'published' || isOwner(resource.data.ownerId);
      allow list: if true;
      allow create: if isOwner(request.resource.data.ownerId);
      allow update, delete: if isOwner(get(/databases/$(database)/documents/pages/$(pageId)).data.ownerId);

      match /links/{linkId} {
        allow get, list: if true;
        allow write: if isOwner(get(/databases/$(database)/documents/pages/$(pageId)).data.ownerId);
      }

      // Analytics Data
      match /page_views/{viewId} {
        allow get, list: if isSignedIn() && exists(/databases/$(database)/documents/pages/$(pageId)) && get(/databases/$(database)/documents/pages/$(pageId)).data.ownerId == request.auth.uid;
        allow write: if true;
      }

      match /link_clicks/{clickId} {
        allow get, list: if isSignedIn() && exists(/databases/$(database)/documents/pages/$(pageId)) && get(/databases/$(database)/documents/pages/$(pageId)).data.ownerId == request.auth.uid;
        allow write: if true;
      }
    }

    // Blog Posts - DEFINITIVE FIX
    match /posts/{postId} {
        // READ Rule (GET + LIST): A user can read a post if it is published OR they are the owner.
        // This single rule securely covers both public queries (where status == 'published')
        // and private queries by the owner (where ownerId == auth.uid).
        allow read: if resource.data.status == 'published' || isOwner(resource.data.ownerId);

        // WRITE Rules:
        // On create, the new document's ownerId must match the user.
        allow create: if isOwner(request.resource.data.ownerId);
        // On update/delete, the existing document's ownerId must match the user.
        allow update, delete: if isOwner(get(/databases/$(database)/documents/posts/$(postId)).data.ownerId);
    }

    // Page Slug Lookups
    match /slug_lookups/{slug} {
      allow get: if true;
      allow create: if !exists(/databases/$(database)/documents/slug_lookups/$(slug)) && isOwner(get(/databases/$(database)/documents/pages/$(request.resource.data.pageId)).data.ownerId);
      allow update: if isOwner(get(/databases/$(database)/documents/pages/$(resource.data.pageId)).data.ownerId);
      allow delete: if isOwner(get(/databases/$(database)/documents/pages/$(resource.data.pageId)).data.ownerId);
    }

    // Username Lookups
    match /username_lookups/{username} {
      allow get: if true;
      allow create: if !exists(/databases/$(database)/documents/username_lookups/$(username)) && isOwner(request.resource.data.userId);
      allow delete: if isOwner(resource.data.userId);
      allow update: if false; // Deleting and creating a new one is safer
    }

    // Short Links (Private management data) - DEFINITIVE FIX
    match /short_links/{code} {
      // READ (GET + LIST): A user can only read documents where the `ownerId` field matches their own UID.
      // The client query MUST include `where('ownerId', '==', request.auth.uid)` to satisfy this rule.
      allow read: if isSignedIn() && resource.data.ownerId == request.auth.uid;
    
      // CREATE Rule: On create, the new document's ownerId must match the user and the code must not exist.
      allow create: if isOwner(request.resource.data.ownerId) 
                   && !exists(/databases/$(database)/documents/short_links/$(code));
                   
      // UPDATE/DELETE Rules: The existing document's ownerId must match the user.
      allow update, delete: if isOwner(get(/databases/$(database)/documents/short_links/$(code)).data.ownerId);
    }

    // Short Links (Public data for redirection)
    match /short_link_public/{code} {
      // Anyone can get a link to be redirected.
      allow get: if true;
      
      // Anyone can update the clickCount, but not the originalUrl or add other fields.
      allow update: if request.resource.data.keys().hasOnly(['originalUrl', 'clickCount']) 
                   && request.resource.data.originalUrl == resource.data.originalUrl;

      // Creation/deletion only by owner of the corresponding private link.
      // This requires the user to be signed in.
      allow create, delete: if isSignedIn() && get(/databases/$(database)/documents/short_links/$(code)).data.ownerId == request.auth.uid;
    }
  }
}
